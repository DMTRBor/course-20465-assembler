name: Build & Test

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-16.04-docker, windows-2022]

    runs-on: ${{ matrix.os == 'windows-2022' && 'windows-2022' || 'ubuntu-latest' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show runner OS info
        run: |
          if [ "${{ matrix.os }}" == "windows-2022" ]; then
            systeminfo
            echo %PROCESSOR_ARCHITECTURE%
          else
            uname -a
            lsb_release -a || true
          fi
        shell: bash

      ######################################################################
      # LINUX — DOCKER UBUNTU 16.04
      ######################################################################

      - name: Build Docker image (Ubuntu 16.04)
        if: matrix.os == 'ubuntu-16.04-docker'
        run: |
          echo ">>> Building Docker image for Ubuntu 16.04..."
          docker build -t assembler-dev:ubuntu16.04 .

      - name: Build assembler inside Docker
        if: matrix.os == 'ubuntu-16.04-docker'
        run: |
          # Get the current runner user's UID and GID
          USER_ID_MAP="$(id -u):$(id -g)"
          echo "Current runner user mapping: $USER_ID_MAP"

          echo ">>> Building assembler inside Docker..."
          docker run --rm \
            --user "$USER_ID_MAP" \
            -v "$PWD":/workspace \
            -w /workspace \
            assembler-dev:ubuntu16.04 \
            bash -c "set -e; make clean; make"

      - name: Run tests inside Docker
        if: matrix.os == 'ubuntu-16.04-docker'
        run: |
          # Get the current runner user's UID and GID
          USER_ID_MAP="$(id -u):$(id -g)"
          echo "Current runner user mapping: $USER_ID_MAP"

          docker run --rm \
            --user "$USER_ID_MAP" \
            -v "$PWD":/workspace \
            -w /workspace \
            assembler-dev:ubuntu16.04 \
            bash -c '
              set -e;
              EXEC=./assembler;
              TEST_ROOT=test;
              
              if [ ! -x "$EXEC" ]; then
                echo "ERROR: Executable $EXEC not found.";
                exit 1;
              fi;

              echo ">>> Running assembler tests inside Docker..."
              for sub in valid invalid; do
                for as_file in "$TEST_ROOT/$sub"/*.as; do
                  [ -f "$as_file" ] || continue;
                  base_no_ext="${as_file%.as}";
                  
                  echo ----------------------------------------;
                  echo Running: $EXEC "$base_no_ext";
                  echo ----------------------------------------;
                  
                  $EXEC "$base_no_ext";
                  echo;
                done;
              done
            '
            
      - name: Collect assembler output files (Linux)
        if: matrix.os == 'ubuntu-16.04-docker'
        run: |
          mkdir -p outputs
          echo "Moving assembler output files..."
          find . -type f \( -name "*.am" -o -name "*.ob" -o -name "*.ext" -o -name "*.ent" \) -exec mv {} outputs/ \;
          ls -R outputs/ || true

      ######################################################################
      # WINDOWS — MSVC 2022
      ######################################################################

      - name: Normalize .as files (CRLF)
        if: matrix.os == 'windows-2022'
        shell: powershell
        run: |
          $files = Get-ChildItem -Path test -Filter *.as -Recurse
          foreach ($file in $files) {
            Write-Host "Converting $($file.FullName)"
            $content = (Get-Content -Raw $file.FullName) -replace "`r`n", "`n" -replace "`n", "`r`n"
            $content | Out-File -FilePath $file.FullName -Encoding ASCII
          }

      - name: Build assembler (Windows MSVC)
        if: matrix.os == 'windows-2022'
        shell: cmd
        run: |
          echo Building assembler.exe on Windows...
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64

          cl /nologo /W4 /EHsc /std:c89 /Fe:assembler.exe ^
            assembler.c ^
            data_structs/src/memory_table.c ^
            data_structs/src/macro_list.c ^
            data_structs/src/lines_list.c ^
            data_structs/src/labels_table.c ^
            encoding/src/util.c ^
            encoding/src/data_section.c ^
            encoding/src/code_section.c ^
            machine/src/machine.c ^
            processing/src/pre_assembler.c ^
            processing/src/first_pass.c ^
            processing/src/second_pass.c ^
            utils/src/utils.c ^
            utils/src/errors_handling.c ^
            utils/src/build_output.c

      - name: Run tests (Windows MSVC)
        if: matrix.os == 'windows-2022'
        shell: cmd
        run: |
          SET EXEC=assembler.exe
          SET TEST_ROOT=test

          IF NOT EXIST %EXEC% (
            echo ERROR: assembler.exe not found
            exit 1
          )

          echo Running assembler tests on Windows...

          FOR %%S IN (valid invalid) DO (
            echo ============================
            echo Testing %%S
            echo ============================

            FOR %%F IN (%TEST_ROOT%\%%S\*.as) DO (
              SET "FULL=%%F"
              SETLOCAL EnableDelayedExpansion
              SET "NOEXT=!FULL:.as=!"

              echo ---------------------------------------
              echo Running: %EXEC% !NOEXT!
              echo ---------------------------------------

              %EXEC% !NOEXT!
              echo.
              ENDLOCAL
            )
          )

      - name: Collect assembler output files (Windows)
        if: matrix.os == 'windows-2022'
        shell: powershell
        run: |
          Write-Host "Moving assembler output files..."
          New-Item -Path ".\outputs" -ItemType Directory | Out-Null
          Get-ChildItem -Recurse -Include *.am, *.ob, *.ext, *.ent | Move-Item -Destination .\outputs\ -Force
          Write-Host "Moved output files to outputs/ folder."

      ######################################################################
      # ARTIFACT UPLOAD
      ######################################################################

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-assembler-build
          path: |
            ${{ matrix.os == 'windows-2022' && 'assembler.exe' || './assembler' }}
            *.o
            *.obj
            outputs/